<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Agent UI (Single Page)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; }
    .row { display: flex; gap: 16px; }
    .col { flex: 1; }
    textarea { width: 100%; height: 110px; }
    button { padding: 10px 14px; margin-top: 8px; cursor: pointer; }
    .panel { border: 1px solid #ddd; border-radius: 8px; padding: 12px; }
    pre { white-space: pre-wrap; word-wrap: break-word; }
    .msg { margin: 8px 0; }
    .user { font-weight: bold; }
    .assistant { font-weight: bold; }
  </style>
</head>
<body>
  <h2>Minimal Agent UI</h2>

  <div class="row">
    <div class="col panel">
      <h3>Chat</h3>
      <div id="history"></div>

      <textarea id="input" placeholder="Enter your prompt..."></textarea><br/>
      <button id="run">Run Agent</button>
      <span id="status"></span>
    </div>

    <div class="col panel">
      <h3>Latest Final Response</h3>
      <pre id="final"></pre>

      <h3>Steps Trace</h3>
      <pre id="steps"></pre>
    </div>
  </div>

  <script>
    const systemPrompt =
`You are a helpful assistant. Keep answers concise unless asked otherwise.`;

    // Local chat state (front-end)
    const messages = []; // {role: "user"|"assistant", content: string}

    function renderHistory() {
      const el = document.getElementById("history");
      el.innerHTML = "";
      for (const m of messages) {
        const div = document.createElement("div");
        div.className = "msg";
        div.innerHTML = `<span class="${m.role}">${m.role.toUpperCase()}:</span> ${escapeHtml(m.content)}`;
        el.appendChild(div);
      }
    }

    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, s => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
      }[s]));
    }

    function buildPrompt(newUserText, k=8) {
      const tail = messages.slice(-k);
      const history = tail.map(m => `${m.role === "user" ? "User" : "Assistant"}: ${m.content}`).join("\n");
      return `SYSTEM:\n${systemPrompt}\n\nCONVERSATION:\n${history || "(none)"}\n\nNEW USER MESSAGE:\n${newUserText}`;
    }

    async function runAgent() {
      const input = document.getElementById("input");
      const status = document.getElementById("status");
      const finalEl = document.getElementById("final");
      const stepsEl = document.getElementById("steps");

      const userText = input.value.trim();
      if (!userText) return;

      // Append user message immediately
      messages.push({role: "user", content: userText});
      renderHistory();
      input.value = "";

      const compiledPrompt = buildPrompt(userText);

      status.textContent = " Running...";
      finalEl.textContent = "";
      stepsEl.textContent = "";

      try {
        const res = await fetch("/api/execute", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({prompt: compiledPrompt})
        });
        const data = await res.json();

        if (data.status !== "success") {
          throw new Error(data.error || "Unknown error");
        }

        // Append assistant reply to chat history
        messages.push({role: "assistant", content: data.response});
        renderHistory();

        finalEl.textContent = data.response;
        stepsEl.textContent = JSON.stringify(data.steps, null, 2);

        status.textContent = " Done.";
      } catch (e) {
        status.textContent = " Error.";
        finalEl.textContent = String(e);
      }
    }

    document.getElementById("run").addEventListener("click", runAgent);
  </script>
</body>
</html>
